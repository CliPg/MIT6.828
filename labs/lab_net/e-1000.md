## 2.1 引言

本节概述了 PCI/PCI-X 系列千兆以太网控制器。后续章节将详细介绍以太网控制器的功能、寄存器描述以及初始化流程。所有主要接口也将详细说明。

PCI/PCI-X 系列千兆以太网控制器的设计遵循以下原则：
1.	提供包含 10/100/1000 Mb/s PHY 的以太网接口，同时支持 1000 Base-X 实现。
2.	提供尽可能高性能的解决方案，具体包括：
- 通过直接访问所有内存而无需使用映射寄存器
- 尽量减少管理以太网控制器所需的 PCI 目标访问次数
- 尽量减少管理以太网控制器所需的中断次数
- 将简单任务（如 TCP 校验和计算）卸载给主机处理器以外的硬件
- 最大化 PCI 的效率和性能
- 使用混合信号处理确保物理层特性超过 UTP 铜缆介质规范要求
3.	提供简单的软件接口以完成基本操作。
4.	提供高度可配置的设计，以便在不同环境中高效使用。

PCI/PCI-X 系列千兆以太网控制器的架构衍生自 82542 和 82543 设计。它们沿用了前代产品的 MAC 功能和集成铜缆 PHY，同时增加了基于 SMBus 的可管理性以及集成的 ASF 控制器功能。此外，82546GB/EB 在该架构基础上实现了集成双端口方案，由两个独立的 MAC/PHY 实例组成。


### 2.3.1 PCI/PCI-X 核心接口

PCI/PCI-X 核心模块提供了一个**完整且无需额外胶合逻辑（glueless）**的接口，可连接到 33/66 MHz、32/64 位的 PCI 总线，或 33/66/133 MHz、32/64 位的 PCI-X 总线。该模块符合 PCI 总线规范（PCI Bus Specification）Rev 2.2 或 2.3 以及 PCI-X 规范（PCI-X Specification）Rev 1.0a。

以太网控制器支持 32 位或 64 位寻址与数据传输，并提供完整的控制接口，以在 32 位或 64 位的 PCI 或 PCI-X 总线上运行。在为以太网控制器提供专用总线的系统中，该架构可提供足够的带宽以支持持续的 1000 Mb/s 全双工传输速率。
对于共享总线的系统（尤其是 32 位宽接口），虽然可能无法维持完整的 1000 Mb/s 带宽，但仍能保持数百 Mb/s 的持续传输速率。

当以太网控制器作为 PCI 从设备（target） 时，它遵循 PCI 配置规范，使得所有对其的访问在 PCI 系统初始化时，能够自动映射到空闲的内存空间和 I/O 空间中。

在处理发送与接收帧时，以太网控制器作为 PCI 主设备（master） 工作。作为主设备，其在 PCI 总线上的事务突发长度（transaction burst length）由多个因素决定，包括：
- PCI 延迟计时器（latency timer）的到期时间；
- 正在进行的总线传输类型；
- 数据传输的大小；
- 以及该传输是由接收逻辑还是发送逻辑发起的。

PCI/PCI-X 总线接口与 DMA 引擎直接相连。


### 2.3.2 82547GI/EI CSA 接口

CSA（Communication Streaming Architecture，通信流架构）源自 Intel® Hub Architecture（英特尔集线架构）。
82547EI 控制器的 CSA 端口由 11 条数据信号与控制信号、2 条选通信号（strobe）、一个 66 MHz 时钟，以及驱动补偿电阻连接组成。
这些信号的工作细节及其所使用的数据包传输协议均为 Intel 专有技术（proprietary）。

CSA 端口的理论带宽为 266 MB/s，大约是 32 位 33 MHz PCI 总线峰值带宽的两倍。

CSA 端口架构对于系统软件和操作系统而言是透明的，因此可以使用类似传统 PCI 的方式进行配置。


### 2.3.3 DMA 引擎与数据 FIFO

DMA（直接内存访问）引擎负责在主机内存与片上内存之间传输接收和发送的数据以及描述符。

在**接收路径（Receive Path）**中，DMA 引擎将存储在接收数据 FIFO 缓冲区中的数据传输到主机内存中由描述符指定地址的接收缓冲区。同时，它还会从主机内存中获取并回写更新后的接收描述符。

在**发送路径（Transmit Path）**中，DMA 引擎将主机内存缓冲区中存储的数据传输到发送数据 FIFO 缓冲区中。同时，它也会从主机内存中获取并回写更新后的发送描述符。

以太网控制器的数据 FIFO 模块由一个 64 KB（对于 82547GI/EI 为 40 KB）的片上缓冲区组成，用于接收和发送操作。接收和发送 FIFO 的大小可以根据系统需求进行分配。FIFO 在以太网控制器接收或发送帧时，提供一个临时的数据缓冲存储区域。

DMA 引擎与大容量数据 FIFO 的设计经过优化，旨在最大化 PCI 总线效率并降低处理器占用率，其方式包括：
- 通过在传输前缓存整个待发送的数据包，缓解瞬时的接收带宽需求并消除发送欠载（underrun）问题；
- 在发送 FIFO 中排队等待发送的帧，使以太网控制器能够以最小的帧间间隔（interframe spacing）实现连续发送；
- 使以太网控制器能够在较长的 PCI 总线延迟下仍可正常工作，不会丢失接收数据或损坏发送数据；
- 允许通过调整发送 FIFO 阈值来设置发送启动阈值，从而根据可用的 PCI 带宽、线路速率以及延迟情况优化系统性能；
- 卸载 IP 和 TCP/UDP 校验和的接收与发送计算工作；
- 直接从发送 FIFO 中重新发送发生错误（如冲突检测或数据欠载）的传输数据，从而避免重新访问主机内存中的数据。


## 2.4 DMA 寻址（DMA Addressing）

在合适的系统中，为了支持超过 32 位物理寻址的系统，所有由以太网控制器作为主设备访问的地址均为 64 位地址。
使用 64 位地址可以**消除对特殊段寄存器（segment register）**的需求。

注意：
根据 PCI 2.2 或 2.3 规范的要求，任何高 32 位全为 0b 的 64 位地址都必须以 32 位地址周期的形式出现。以太网控制器完全符合 PCI 2.2 或 2.3 规范的这一要求。

PCI 总线是 小端（little-endian） 架构；然而，并非所有使用 PCI 的系统处理器都将内存视为小端格式。
由于网络数据在本质上是字节流（byte stream），因此处理器与以太网控制器在内存数据的表示方式上必须保持一致。系统默认使用 小端模式（little-endian mode）。

描述符（descriptor）访问不会发生字节交换（byte swap）。

以下示例展示了小端模式下的数据字节顺序。
接收数据包的字节按从左到右的顺序到达：

01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 10 
11 12 13 14 15 16 17 18 19 1a 1b 1c 1d 1e

示例 2-1：字节顺序（Byte Ordering）

数据包缓冲区地址没有对齐限制（alignment restriction）。
主要字（major word）的字节地址在左侧显示，而 PCI 总线对应的**字节编号（byte number）和位编号（bit number）**显示在表格的上方。

表 2-1：小端数据顺序（Little Endian Data Ordering）



## 2.5 以太网寻址（Ethernet Addressing）

在以太网控制器中，有多个寄存器用于存储以太网地址。
每个地址由两个 32 位寄存器组成：一个称为 “高位寄存器”（High），另一个称为 “低位寄存器”（Low）。
例如，接收地址寄存器（Receive Address Register） 由 接收地址高位寄存器（RAH，Receive Address High） 和 接收地址低位寄存器（RAL，Receive Address Low） 组成。

存储在寄存器中的地址的最低有效字节（Least Significant Byte, LSB）的最低有效位（Least Significant Bit, LSB）（例如 RAL 的第 0 位）为多播位（multicast bit）。
在线缆上传输时，最低有效字节是第一个发送的字节。

这种表示方式适用于所有地址寄存器，包括流量控制寄存器（flow control registers）。

图 2-5 展示了线缆上传输的比特/字节顺序与在唯一接收地址寄存器中存储的值之间的对比关系。



## 2.6 中断（Interrupts）

以太网控制器提供了一套完整的中断机制，用于实现高效的软件管理。
该中断结构的设计目标如下：
- 通过使用 “置位（set）” 和 “读清（clear-on-read）” 操作，而非传统的 “读-改-写（read-modify-write）” 操作，使访问过程具备线程安全性（thread-safe）。
- 最小化中断数量，使中断次数与实际完成的工作量成合理比例。
- 降低每个中断的处理开销。


（1）通过四个中断寄存器实现线程安全

Intel 通过设计包含 四个中断寄存器（interrupt registers） 的中断逻辑实现了第一个目标。
这些寄存器的详细说明可见于 第 13.4.17 至 13.4.21 节。

- 中断原因“置位（Set）”与“读取（Read）”寄存器
	- 读取寄存器（Read register） 记录中断的原因。
	- 在读取操作时，所有已置位的位会自动清除（auto-clear）。
	- 当向 置位寄存器（Set register） 写入值时，对应位被写为 1b 的位会在原因寄存器中被置位。
	- 如果在硬件设置中断原因位和软件清除中断之间出现竞争条件（race condition），该位将保持为已置位状态。
	- 对 Set 寄存器 的写操作不存在竞争问题。
	- “置位”操作允许软件手动触发中断，而“读取”操作自动清除，以避免昂贵的写操作。

大多数系统存在写缓冲（write buffering），它虽能降低开销，但通常需要进行一次读操作，以确保写操作已从缓冲区真正刷新（flush）。
如果没有自动清除机制，清除一个中断的代价可能高达 两次读 + 一次写。



- 中断屏蔽“置位（Set）/读取（Read）”与“清除（Clear）”寄存器
	- 当且仅当中断原因位为 1b 且对应的中断屏蔽位也为 1b 时，中断信号才会出现在 PCI 总线上。
	- 软件可以通过清除屏蔽寄存器中的位来阻止中断线被触发。
	- 即使屏蔽位关闭，中断原因位仍会记录中断事件。
	- “置位”和“清除”操作通过避免“读-改-写”方式，使该寄存器更具线程安全性。
	- 写入 Set 寄存器时，对应位被置为 1b；写入 Clear 寄存器时，对应位被清零。
	- 读取 Set 寄存器会返回当前寄存器的实际值。



（2）通过三种机制减少中断次数

Intel 通过以下三种方式实现了中断数量最小化的目标：
1.	降低中断触发频率（见第 13.4.17 节，不适用于 82544GC/EI）；
2.	在发出中断信号前，允许多个接收数据包（receive packets）被批量接收（见第 3.2.3 节）；
3.	减少甚至消除发送过程中的中断需求（见第 3.2.7 节）。


（3）通过中断信息集中寄存器降低处理开销

第三个目标（降低中断处理开销）是通过一个整合所有中断信息的寄存器来实现的，
这使得不再需要多次访问不同的中断寄存器，从而简化处理流程。


（4）支持消息信号中断（MSI）

此外，以太网控制器还支持 消息信号中断（Message Signaled Interrupts, MSI），
该机制在 PCI 2.2、2.3 和 PCI-X 规范中定义。
有关详细信息，请参见 第 4.1.3.1 节。




